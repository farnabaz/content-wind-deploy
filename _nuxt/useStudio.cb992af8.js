import{a4 as g,v as y,$ as P,a7 as C,ag as I,ah as $,ai as x,i as R,aj as S,af as U}from"./entry.47dabcf0.js";import _ from"./ContentPreviewMode.9de97048.js";/* empty css                                                                           */const L=(h,r,c)=>{const d=[...r||[]],s=[...c||[]],o=[...h||[]];for(const e of d)if(e.oldPath)if(s.splice(s.findIndex(a=>a.path===e.oldPath),1),d.find(a=>a.path===e.oldPath))o.push({path:e.path,parsed:e.parsed});else{const a=o.find(l=>l.path===e.oldPath);a&&(a.path=e.path,e.parsed?a.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(l=>{a.parsed[l]=e.pathMeta[l]}))}else if(e.new)o.push({path:e.path,parsed:e.parsed});else{const p=o.find(a=>a.path===e.path);p&&Object.assign(p,{path:e.path,parsed:e.parsed})}for(const e of s)o.splice(o.findIndex(p=>p.path===e.path),1);return o},A=h=>{let r;return(...c)=>(r||(r=h()),r)},O=A(()=>{const h=g(),r=JSON.parse(JSON.stringify(y())),c=P().public.studio||{},d=C("client-db",()=>null),s=I("previewToken",{sameSite:"none",secure:!0}),o=async(t,i,n=!0)=>{const u=await t.getKeys(`${s.value}:`);await Promise.all(u.map(m=>t.removeItem(m))),await t.setItem(`${s.value}$`,JSON.stringify({ignoreBuiltContents:n})),await Promise.all(i.map(m=>{var f;return t.setItem(`${s.value}:${(f=m.parsed)==null?void 0:f._id}`,JSON.stringify(m.parsed))}))},e=t=>{$(h,x,[t||r])},p=async t=>{const i=await $fetch("api/projects/preview",{baseURL:c.apiURL,params:{token:s.value}}),n=L(i.files,i.additions,i.deletions),u=n.filter(v=>v.path.startsWith("content"));await o(t,u,(i.files||[]).length!==0);const f=n.filter(v=>v.path.startsWith(".studio")).find(v=>v.path===".studio/app.config.json");e(f==null?void 0:f.parsed)},a=async()=>{await $fetch("api/projects/preview/sync",{baseURL:c.apiURL,method:"POST",params:{token:s.value}})},l=t=>{const i=R(()=>!!t.value),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),S(_,{previewToken:s,apiURL:c.apiURL,storageReady:i,refresh:()=>p(t.value).then(()=>U()),init:a}).mount(n)},w=async t=>{var n,u;if(!t)return null;t=t.replace(/\/$/,"");let i=await((n=d.value)==null?void 0:n.getItem(`${s.value}:${t}`));return i||(i=await((u=d.value)==null?void 0:u.getItem(t))),i};return{apiURL:c.apiURL,previewToken:s,contentStorage:d,syncPreview:p,syncPreviewFiles:o,syncPreviewAppConfig:e,requestPreviewSynchronization:a,mountPreviewUI:l,findContentWithId:w}});export{O as useStudio};
